\documentclass{article}

\usepackage{amsmath} % align*-environment
\usepackage{amssymb} % e.g. \mathbb{R}
\usepackage{amsthm} % newtheorem

\newtheorem{lemma}{Lemma}

\newcommand{\R}{\mathbb{R}}
\newcommand{\vctr}[1]{\mathbf{#1}}
\newcommand{\point}[1]{\mathbf{#1}}

\newcommand{\mat}[1]{\mathbf{#1}}
\newcommand{\pMat}[2]{\mat{P_{#1 \leftarrow #2}}}
\newcommand{\vMat}[2]{\mat{V_{#1 \leftarrow #2}}}
\newcommand{\nMat}[2]{\mat{N_{#1 \leftarrow #2}}}

\newcommand{\colvec}[1]{\begin{pmatrix}#1\end{pmatrix}}

\DeclareMathOperator{\adj}{adj}

\begin{document}

overview:
\begin{itemize}
 \item intro/motivation
 \item normal matrices in general
 \begin{itemize}
 \item how to compute the inverse matrix with the adjoint method and with the cross products
 \item why do we need to use the inverse transpose when transforming normals
 \end{itemize}
 \item how to transform from tangent space to world space
 \begin{itemize}
 \item define tangent space coordinates of \(\point{p}\) (and define point \(\point{p_\perp}\))
 \item barycentric coordinates and how to transform point \(\point{p_\perp}\) from its uv-coordinates to object space
 \item how to transform points \(\point{p}\) from tangent space to object space
 \item how to transform vectors and normals from tangent space to object space
 \item interpolating the normal matrices
 \end{itemize}
 \item preprocessing the normals in tangent space: 
 \begin{itemize}
  \item unpack normals from \([0, 1]^3\) to \([-1, 1]^3\)
  \item flip v-axis if necessary (inverse transpose is the same)
  \item scale tangent space along the normal direction (inverse transpose divides by scale factor)
 \end{itemize}

\end{itemize}

\newpage

\section{Introduction}


\section{Transforming Normals}

\subsection{Matrix Inversion using the Adjugate Matrix and Cross Products}

\subsection{Why Normals should be Transformed with the Inverse Transpose}

\begin{lemma}
Let \(\mat{M} \in \R^{3\times 3}\) be an invertible matrix. And let \(\vctr{a}, \vctr{b} \in \R^3\). Then
\[
(\mat{M}\vctr{a})\times(\mat{M}\vctr{b}) = \adj(\mat{M}) (\vctr{a} \times \vctr{b})
\]
\end{lemma}
\begin{proof}
 ...
\end{proof}


\section{Transforming from Tangent Space to Object Space}

\subsection{Definition of Tangent Space Coordinates}
For points \(\point{p}\) that are not necessarily located on the surface we want to define tangent space coordinates. Let \(\point{p_\perp}\) be the point that we get by perpendicularly projecting \(\point{p}\) onto the triangle. We define the first two coordinates of the tangent space coordinates of \(\point{p}\) to be the uv-texture coordinates of \(\point{p_\perp}\). And the third tangent space cooordinate of \(\point{p}\) shall be the signed distance \(d\) of \(\point{p}\) from the triangle.
\begin{equation*}
 \point{p_{tc}} := \colvec{u \\ v \\ d}
\end{equation*}

\subsection{barycentric coordinates}

\[
\point{p} = \lambda_0 \point{p_0} + \lambda_1 \point{p_1} + \lambda_2 \point{p_2}
\]
where \(\lambda_0 + \lambda_1 + \lambda_2 = 1\).

Plugging in \(\lambda_0 = 1 - \lambda_1 - \lambda_2\):
\begin{align*}
%p &= (1 - \lambda_1 - \lambda_2) p_0 + \lambda_1 p_1 + \lambda_2 p_2 \\
\point{p} &= \point{p_0} - \lambda_1 \point{p_0} - \lambda_2 \point{p_0}  + \lambda_1 \point{p_1} + \lambda_2 \point{p_2} \\
&= \point{p_0}  + \lambda_1 (\point{p_1}-\point{p_0}) + \lambda_2 (\point{p_2} - \point{p_0})\\
&= \point{p_0} + \lambda_1 \point{\Delta p_1} + \lambda_2 \point{\Delta p_2}
\end{align*}

where
\begin{align*}
\point{\Delta p_1} &:= \point{p_1} - \point{p_0}\\
\point{\Delta p_2} &:= \point{p_2} - \point{p_0}
\end{align*}

Thus
\[
 \colvec{\point{p}\\1} = \pMat{oc}{bc} \colvec{\lambda_1 \\ \lambda_2 \\ 1}
\]
where
\begin{equation}
\label{eq:mat_oc_from_bc}
 \pMat{oc}{bc} := \begin{pmatrix} 
                  \point{\Delta p_1} & \point{\Delta p_2} & \point{p_0} \\
                  0 & 0 & 1
                 \end{pmatrix}
\end{equation}


\subsection{Transforming from Texture Coordinates to Object Space}

Similar to equation (\ref{eq:mat_oc_from_bc}) we can construct a matrix to transform from (the last two components of) barycentric coordinates to texture coordinates
\[
 \colvec{u \\ v \\1} = \pMat{uv}{bc} \colvec{\lambda_1 \\ \lambda_2 \\ 1}
\]
where
\begin{equation}
 \pMat{uv}{bc} := \begin{pmatrix} 
                  \Delta u_1 & \Delta u_2 & u_0 \\
                  \Delta v_1 & \Delta v_2 & v_0 \\
                  0 & 0 & 1
                 \end{pmatrix}
\end{equation}
where
\begin{align*}
 \colvec{\Delta u_1 \\ \Delta v_1} := \colvec{u_1 \\ v_1} - \colvec{u_0 \\ v_0}\\
 \colvec{\Delta u_2 \\ \Delta v_2} := \colvec{u_2 \\ v_2} - \colvec{u_0 \\ v_0}
\end{align*}

By taking a detour through barycentric coordinates we can now also transform points from texture coordinates to object coordinates.
\begin{equation*}
\colvec{\point{p}\\1} = \pMat{oc}{uv} \colvec{u \\ v \\1} 
\end{equation*}
where
\begin{equation*}
 \pMat{oc}{uv} := \pMat{oc}{bc}(\pMat{uv}{bc}^{-1}) 
\end{equation*}




\subsection{Transforming Points from Tangent Space to Object Space}
\begin{align*}
 \point{p} &= \point{p_\perp} + d \vctr{n}\\
 &= \point{p_0} + \lambda_1 \point{\Delta p_1} + \lambda_2 \point{\Delta p_2} + d \vctr{n}
\end{align*}

Thus
\[
 \colvec{\point{p}\\1} = \pMat{oc}{(bc+d)} \colvec{\lambda_1 \\ \lambda_2 \\ d \\ 1}
\]
where
\begin{equation}
\label{eq:mat_oc_from_bdc}
 \pMat{oc}{(bc+d)} := \begin{pmatrix} 
                  \point{\Delta p_1} & \point{\Delta p_2} & \vctr{n} & \point{p_0} \\
                  0 & 0 & 0 & 1
                 \end{pmatrix}
\end{equation}

\[
 \colvec{u \\ v \\ d \\1} = \pMat{(uv+d)}{(bc+d)} \colvec{\lambda_1 \\ \lambda_2 \\ d \\ 1}
\]
where
\begin{equation}
 \pMat{(uv+d)}{(bc+d)} := \begin{pmatrix} 
                  \Delta u_1 & \Delta u_2 & 0 & u_0 \\
                  \Delta v_1 & \Delta v_2 & 0 & v_0 \\
                  0 & 0 & 1 & 0 \\
                  0 & 0 & 0 & 1
                 \end{pmatrix}
\end{equation}

\begin{equation*}
\colvec{\point{p}\\1} = \pMat{oc}{tc} \colvec{u \\ v \\ d \\ 1} 
\end{equation*}
where
\begin{equation*}
 \pMat{oc}{tc} := \pMat{oc}{(bc+d)}(\pMat{(uv+d)}{(bc+d)}^{-1}) 
\end{equation*}

\subsection{Transforming Normals from Tangent Space to Object Space}

Lets first see how to transform vectors:
\begin{equation*}
 \vMat{oc}{tc} := \vMat{oc}{(bc+d)}(\vMat{(uv+d)}{(bc+d)}^{-1}) 
\end{equation*}
where
\begin{equation}
\label{eq:vmat_oc_from_bdc}
 \vMat{oc}{(bc+d)} := \begin{pmatrix} 
                  \point{\Delta p_1} & \point{\Delta p_2} & \vctr{n} 
                 \end{pmatrix}
\end{equation}

\begin{equation}
 \vMat{(uv+d)}{(bc+d)} := \begin{pmatrix} 
                  \Delta u_1 & \Delta u_2 & 0 \\
                  \Delta v_1 & \Delta v_2 & 0 \\
                  0 & 0 & 1 
                 \end{pmatrix}
\end{equation}

\begin{align*}
\nMat{oc}{tc} &:= (\vMat{oc}{(bc+d)}^{-1})^T(\vMat{(uv+d)}{(bc+d)}^T) \\
  &= \frac{1}{(\point{\Delta p_1} \times \point{\Delta p_2)}\cdot \vctr{n}}\begin{pmatrix} 
        \point{\Delta p_2} \times \vctr{n} & \vctr{n} \times \point{\Delta p_1} & \point{\Delta p_1} \times \point{\Delta p_2}
     \end{pmatrix}
     \begin{pmatrix} 
                  \Delta u_1 & \Delta v_1 & 0 \\
                  \Delta u_2 & \Delta v_2 & 0 \\
                  0 & 0 & 1 
     \end{pmatrix}
\end{align*}

\subsection{Interpolating the Normal Matrices}

\section{Preprocessing Steps}

\end{document}
